@model IEnumerable<Institution>
@{
    ViewData["Title"] = "Equalize";
   
}


<!DOCTYPE html>
<html>
<head>
    <title>Equalize Page</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        .card-header {
            background-color: #dc3545; 
            color: white;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
        </header>

        <nav>

        </nav>

        <main>
            <div class="card">
                <div class="card-header">
                    <h3>معلومات الطالب</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="previousInstitution">المنشأة السابقة</label>
                                <select class="form-control" id="institutionId" onchange="fetchMajors(this.value)">
                                    <option value="">إختر المنشأة</option>
                                    @foreach (var institution in Model)
                                    {
                                        <option value="@institution.institutionID">@institution.institutionNameAR</option>
                                    }
                                </select>

                            </div>
                            <div class="form-group">
                                <label for="major">التخصص</label>
                                <select class="form-control" id="major" onchange="fetchCourses()">
                                    <option value="">إختر التخصص</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="studentName">اسم الطالب</label>
                                <input type="text" class="form-control" id="studentName">
                            </div>
                            <div class="form-group">
                                <label for="studentId">الرقم الجامعي للطالب</label>
                                <input type="text" class="form-control" id="studentId">
                            </div>
                        </div>
                        <div class="col-md-6 ">
                            <div class="form-group">
                                <label for="nationality">الجنسية</label>
                                <select class="form-control" id="nationality">
                                    <option value="">إختر الجنسية</option>
                                    <option value="jordanian" selected>اردني</option>
                                    <option value="foreigner" disabled>اجنبي</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="Case">الحالة</label>
                                <select class="form-control" id="Case">
                                    <option value="Case">إختر الحالة</option>
                                    <option value="ComingFromUniversity" disabled>مجسر</option>
                                    <option value="ComingFromCollege" selected>منتقل</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <h3>اختيار المواد المجتازة</h3>
                </div>
                <div class="text-center mt-4">
                    <button type="button" class="btn btn-primary btn-danger" onclick="equalize()">Equalize</button>
                </div>
                <div class="card-body">
                    <table class="table" id="course">
                        <thead>
                            <tr>
                                <th>اسم المادة</th>
                                <th>وصف المادة</th>
                                <th>وزن المادة</th>
                                <th>مجتازة</th>
                            </tr>
                        </thead>
                        <tbody>
                            
                        </tbody>
                    </table>
                </div>
            </div>

            
        </main>


    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</body>
</html>

<script>

    function fetchMajors(id) {
        $.ajax({
            url: '/Equalize/getMajors/' + id,
            type: 'GET',
            success: function (data) {
                $('#major').empty(); 
                $.each(data, function (index, item) {
                    $('#major').append('<option value="' + 0 + '">' + 'اختر التخصص' + '</option>');

                    $('#major').append('<option value="' + item.majorID + '">' + item.majorNameAR + '</option>');
                });
                institutionId = id;
            },
            error: function (xhr, status, error) {
                console.error(error);
            }
        });
    }
</script>
<script>
    function fetchCourses() {
        var majorId = $('#major').val();
        var institutionId = $('#institutionId').val();
        $.ajax({
            
            url: '/Equalize/getCourses/',
            type: 'GET',
            data: { institutionId: institutionId, majorId: majorId },
            success: function (result) {
                $('#course tbody').empty();
                $.each(result, function (index, item) {
                    var row = '<tr>' +
                        '<td>' + item.courseNameAR + '</td>' +
                        '<td>' + item.courseDescriptionAR + '</td>' +
                        '<td>' + item.courseWeightAR + '</td>' +
                        '<td> <input type="checkbox" name="pass"> </td>' +
                        '</tr>';
                    $('#course tbody').append(row);
                });
            },
            error: function (xhr, status, error) {
                console.error(error);
            }
        });
    }
</script>
<script>
    function equalize() {
        var institutionId = $('#institutionId').val();
        var majorId = $('#major').val();
        var studentName = encodeURIComponent($('#studentName').val());
        var studentId = encodeURIComponent($('#studentId').val());
        var nationality = $('#nationality').val();
        var caseStatus = $('#Case').val();

        var checkedCourses = [];
        $('#course tbody input[name="pass"]:checked').each(function () {
            checkedCourses.push(encodeURIComponent($(this).closest('tr').find('td:first').text()));
        });

        var url = '/Equalize/equalizedCourses?institutionId=' + institutionId +
            '&majorId=' + majorId +
            '&studentName=' + studentName +
            '&studentId=' + studentId +
            '&nationality=' + nationality +
            '&caseStatus=' + caseStatus +
            '&courses=' + checkedCourses.join(',');

        window.location.href = url;
    }
</script>